{% extends "base.html" %}
 {% load i18n %}
{% block content %}
<head>
    {#TODO necessary? #}
    {% csrf_token %}


	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Live input record and playback</title>
  <style type='text/css'>
    ul { list-style: none; }
    #recordingslist audio { display: block; margin-bottom: 10px; }
  </style>
</head>
<body>

  <h1>Recorder.js simple WAV export example</h1>

  <p>Make sure you are using a recent version of Google Chrome.</p>
  <p>Also before you enable microphone input either plug in headphones or turn the volume down if you want to avoid ear splitting feedback!</p>

  <button onclick="startRecording(this);">record</button>
  <button onclick="stopRecording(this);" disabled>stop</button>
  
  <h2>Recordings</h2>
  <ul id="recordingslist"></ul>
  <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script> 
  <script>

  var audio_context;
  var recorder;

  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);

    recorder = new Recorder(input);
  }

  function startRecording(button) {
    recorder && recorder.record();
    button.disabled = true;
    button.nextElementSibling.disabled = false;
  }

  function stopRecording(button) {
    recorder && recorder.stop();
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    
    // create WAV download link using audio data blob
    createDownloadLink();
    
    recorder.clear();
  }

  function createDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
      var url = URL.createObjectURL(blob);
      var li = document.createElement('li');
      var au = document.createElement('audio');
      var hf = document.createElement('p');

      var button = document.createElement('button');
      var t = document.createTextNode("Upload?");
      var uploaded = false;
      button.id = 'button';
      button.disabled = true;
      button.appendChild(t);

      button.onclick = function() {
          upload(blob);
          t.nodeValue = "Done!"
          button.disabled = true;
          uploaded = true;
      };
      au.controls = true;
      au.onplay =  function() {
          if (!uploaded) button.disabled = false;
      }
      au.src = url;
      hf.innerHTML = 
          "{% trans "please listen to your recording before you upload" %}";
      li.appendChild(au);
      li.appendChild(hf);
      li.appendChild(button);

      recordingslist.appendChild(li);
    });
  }

  window.onload = function init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
      window.URL = window.URL || window.webkitURL;
      
      audio_context = new AudioContext;
    } catch (e) {
      alert('No web audio support in this browser!');
    }
    
    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
    });
  };
// Required for Django CSRF
function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
 
// Actual Upload function using xhr
function upload(blob){
        var csrftoken = getCookie('csrftoken');
 
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'upload/', true);
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
        xhr.setRequestHeader("MyCustomHeader", "Put anything you need in here, like an ID");
 
        xhr.upload.onloadend = function() {
        }
 
        xhr.send(blob);
}
  </script>

  {% load static %}
  <script src="{% static "recorder.js" %}"></script>
{% endblock %}
